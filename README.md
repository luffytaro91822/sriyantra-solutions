# Sriyantra Solutions - Invoicing App Database Setup

This file contains the complete SQL script to set up your Supabase database for the invoicing application.

## Instructions

1.  Navigate to your Supabase project.
2.  Go to the **SQL Editor** in the sidebar.
3.  Click on **"+ New query"**.
4.  Copy the entire SQL script below and paste it into the editor.
5.  Click **"Run"**.

This will create all the necessary tables, relationships, and **secure Row Level Security (RLS) policies** for a multi-user application.

---

## Full SQL Setup Script

```sql
-- 1. Create an ENUM type for invoice statuses
CREATE TYPE public.invoice_status AS ENUM (
    'Draft',
    'Unpaid',
    'Paid',
    'Overdue'
);

-- 2. Create the 'customers' table with user ownership
CREATE TABLE public.customers (
    id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    name text NOT NULL,
    address text NOT NULL,
    phone text NOT NULL,
    gstin text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Add indexes for performance
CREATE INDEX ON public.customers (user_id);

-- 3. Create the 'products' table with user ownership
CREATE TABLE public.products (
    id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    name text NOT NULL,
    unit_price numeric NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Add indexes for performance
CREATE INDEX ON public.products (user_id);

-- 4. Create the 'company_info' table with a unique constraint for user
CREATE TABLE public.company_info (
    id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    name text NOT NULL,
    address text NOT NULL,
    phone text NOT NULL,
    gstin text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Add indexes for performance
CREATE INDEX ON public.company_info (user_id);

-- 5. Create the 'invoices' table with user ownership
CREATE TABLE public.invoices (
    id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    invoice_number text NOT NULL,
    invoice_date date NOT NULL,
    due_date date NOT NULL,
    customer_id uuid,
    items jsonb NOT NULL,
    subtotal numeric NOT NULL,
    gst_percent numeric NOT NULL,
    gst_amount numeric NOT NULL,
    total_amount numeric NOT NULL,
    notes text,
    status public.invoice_status DEFAULT 'Unpaid'::public.invoice_status NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT invoices_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id) ON DELETE SET NULL
);
-- Add indexes for performance
CREATE INDEX ON public.invoices (user_id);
CREATE INDEX ON public.invoices (customer_id);

-- 6. Enable Row Level Security (RLS) for all tables
ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.company_info ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.invoices ENABLE ROW LEVEL SECURITY;

-- 7. Create SECURE RLS policies for all tables
-- These policies ensure that users can only access and modify their own data.

-- Customers Policies
CREATE POLICY "Users can manage their own customers" ON public.customers
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Products Policies
CREATE POLICY "Users can manage their own products" ON public.products
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Company Info Policies
CREATE POLICY "Users can manage their own company info" ON public.company_info
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Invoices Policies
CREATE POLICY "Users can manage their own invoices" ON public.invoices
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- 8. (Optional) This step is no longer needed as default data should be user-specific.
-- Each new user will have default company info created for them by the application logic.

```